<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Interactive NPD Production Dashboard</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Solitaire">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
    <style>
        /* Base styles */
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; overflow-x: hidden; }
        /* Sticky header for the table */
        #dataTable thead th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; font-size: 0.75rem; }
        /* Alternating row color for the table */
        #dataTable tbody tr:nth-child(even) { background-color: #f3f4f6; }
        /* Table container */
        .table-container { max-height: 60vh; overflow: auto; border: 1px solid #e5e7eb; border-radius: 0.375rem; }
        /* Drop zone styling */
        #dropZone { border: 2px dashed #cbd5e1; padding: 2rem; text-align: center; cursor: default; transition: background-color 0.2s ease, border-color 0.2s ease; border-radius: 0.375rem; background-color: #f9fafb; }
        #dropZone.dragover { background-color: #e0f2fe; border-color: #38bdf8; }
        /* Chart container */
        .chart-container, .small-chart-container { position: relative; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #fff; padding: 1rem; margin-top: 1rem; }
        .chart-container { height: 50vh; }
        .small-chart-container { height: 30vh; }
        /* Expand button styling */
        .expand-button {
            position: absolute; top: 0.5rem; right: 0.5rem; z-index: 20;
            padding: 0.25rem; background-color: rgba(243, 244, 246, 0.7);
            border: 1px solid rgba(209, 213, 219, 0.7); border-radius: 0.375rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        .expand-button:hover { background-color: rgba(229, 231, 235, 0.9); }
        .expand-button svg { width: 1rem; height: 1rem; color: #4b5563; }
        /* Chart Modal Styling */
        #chartModal.hidden { display: none !important; }
        #chartModal { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; }
        #modalOverlayElem { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.75); z-index: 100; } /* Updated ID & fixed */
        #modalContent { position: relative; background-color: white; border-radius: 0.5rem; padding: 2rem; width: 90vw; height: 85vh; display: flex; flex-direction: column; z-index: 102; }
        #modalChartContainer { flex-grow: 1; position: relative; }
        #closeModalButton { position: absolute; top: 0.5rem; right: 0.75rem; background: none; border: none; font-size: 2rem; color: #6b7280; cursor: pointer; line-height: 1; z-index: 103; }
        #closeModalButton:hover { color: #1f2937; }

        /* KPI Card Styling */
        .kpi-card { background-color: #fff; padding: 1.25rem; border-radius: 0.5rem; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); border: 1px solid #e5e7eb; display: flex; flex-direction: column; }
        .kpi-title { font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500; }
        .kpi-value { font-size: 1.25rem; font-weight: 600; color: #1f2937; }
        .kpi-subvalue { font-size: 0.875rem; color: #4b5563; }
        .kpi-unit { font-size: 0.75rem; color: #4b5563; margin-left: 0.25rem; }
        /* Filter panel styling */
        #filterPanel { transition: transform 0.3s ease-in-out; }
        .filter-section label { display: block; margin-bottom: 0.25rem; font-size: 0.875rem; font-weight: 500; color: #374151; }
        .filter-section select, .filter-section input[type="month"], #diveInFieldSelect { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.875rem; background-color: #fff; }
        .filter-section select[multiple] { height: 15rem; }
        /* Dive-in section styling */
        #fieldDiveInArea { border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; margin-top: 1.5rem; background-color: #f9fafb; }
        #diveInHeader { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 0.75rem; }
        #diveInHeader h2 { margin-bottom: 0; }
        #diveInHeader .select-container { min-width: 200px; max-width: 100%; }
        /* Burger menu button */
        #burgerButton { z-index: 50; }
        /* Overlay for closing menu */
        #filterOverlay { transition: opacity 0.3s ease-in-out; }
        /* Helper class for hidden */
        .hidden { display: none; }
        /* Color coding for fields */
        .field-oil { background-color: #e0f2fe; color: #0284c7; padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-weight: 500; }
        .field-gas { background-color: #ffe4e6; color: #e11d48; padding: 0.1rem 0.3rem; border-radius: 0.25rem; font-weight: 500; }
        /* Clickable field name styling */
        .clickable-field-name { cursor: pointer; }
        .clickable-field-name:hover { text-decoration: underline; }
        /* Preset button styling */
        .preset-button, .toggle-button { padding: 0.25rem 0.75rem; border: 1px solid #d1d5db; border-radius: 9999px; font-size: 0.75rem; background-color: #fff; color: #374151; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease; }
        .preset-button:hover, .toggle-button:hover { background-color: #f3f4f6; }
        .preset-button.active, .toggle-button.active { background-color: #3b82f6; color: #fff; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 p-0 md:p-4 font-sans relative">

    <div id="filterOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>
    <div id="filterPanel" class="fixed inset-y-0 left-0 w-72 md:w-80 bg-white p-6 shadow-lg z-50 transform -translate-x-full">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold">Main Filters</h2>
            <button id="closeFilterButton" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
        </div>
        <div class="space-y-6">
            <div class="filter-section">
                <label for="fieldFilter">Field(s) (for KPIs & Main Chart):</label>
                <select id="fieldFilter" multiple> </select>
            </div>
            <div class="filter-section">
                <label for="startDate">Start Date:</label>
                <input type="month" id="startDate">
            </div>
            <div class="filter-section">
                <label for="endDate">End Date:</label>
                <input type="month" id="endDate">
            </div>
            <div>
                 <button id="resetFiltersButton" class="w-full px-3 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 text-sm">Reset Filters</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto bg-white p-4 md:p-6 rounded-lg shadow-md min-h-screen">
         <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Advanced Norwegian Field Production Dashboard</h1>
            <button id="burgerButton" class="p-2 rounded hover:bg-gray-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                </svg>
            </button>
        </div>

        <div id="status" class="mb-4 p-3 bg-blue-100 text-blue-800 rounded text-sm hidden">Loading data...</div>
        <div id="error" class="hidden mb-4 p-3 bg-red-100 text-red-800 rounded text-sm">Error loading data.</div>

        <div id="dropZone" class="mt-4 rounded-md">
             <p class="text-gray-600 font-medium mb-2">Load Production Data</p>
             <p class="text-sm text-gray-500 mb-4">Drag & drop the CSV file here, or browse to upload.</p>
             <div class="flex justify-center items-center gap-4">
                 <button id="browseButton" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm">
                     Browse Files
                 </button>
                 <span class="text-sm text-gray-500">or</span>
                 <a id="csvDownloadLink" href="#" target="_blank" class="text-sm text-blue-600 hover:underline">
                     Download Source CSV
                 </a>
             </div>
             <input type="file" id="fileInput" accept=".csv" class="hidden">
        </div>


        <div id="dashboardContent" class="hidden">
            <div class="flex justify-between items-center mt-6 mb-3">
                 <h2 class="text-lg font-semibold text-gray-700">Analysis for: <span id="kpiReferenceMonthSpan" class="text-blue-600"></span></h2>
                 <div class="flex gap-2">
                     <button id="prevKpiMonth" class="px-2 py-1 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 text-xs disabled:opacity-50 disabled:cursor-not-allowed">&lt; Prev</button>
                     <button id="nextKpiMonth" class="px-2 py-1 bg-gray-100 border border-gray-300 rounded hover:bg-gray-200 text-xs disabled:opacity-50 disabled:cursor-not-allowed">Next &gt;</button>
                 </div>
             </div>
            <div id="kpiContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <div class="kpi-card animate-pulse"><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-6 bg-gray-300 rounded w-1/2"></div></div>
                <div class="kpi-card animate-pulse"><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-10 bg-gray-300 rounded w-full"></div></div>
                <div class="kpi-card animate-pulse"><div class="h-4 bg-gray-200 rounded w-3/4 mb-2"></div><div class="h-10 bg-gray-300 rounded w-full"></div></div>
            </div>

            <h2 class="text-lg font-semibold text-gray-700 mb-3">Production Trend (Selected Period)</h2>
             <div class="flex flex-wrap gap-x-2 gap-y-2 items-center mb-3 text-sm">
                <div class="font-medium mr-2">Range:</div>
                <div id="datePresetButtons" class="flex flex-wrap gap-1">
                    <button data-range="1y" class="preset-button">1Y</button>
                    <button data-range="5y" class="preset-button">5Y</button>
                    <button data-range="10y" class="preset-button">10Y</button>
                    <button data-range="all" class="preset-button active">All</button>
                </div>
                <div class="flex items-center ml-auto pl-4">
                     <input type="checkbox" id="summarizeYearlyCheckbox" class="mr-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                     <label for="summarizeYearlyCheckbox" class="text-xs text-gray-700">Summarize Yearly</label>
                </div>
            </div>
            <div class="chart-container" id="mainChartContainer">
                <button class="expand-button" data-chart-type="main" title="Expand Chart">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /> </svg>
                 </button>
                <canvas id="productionChart"></canvas>
            </div>

            <div id="fieldDiveInArea" class="hidden">
                 <div id="diveInHeader">
                     <h2 class="text-lg font-semibold text-gray-700">Field Analysis:</h2>
                     <div class="select-container">
                         <label for="diveInFieldSelect" class="sr-only">Select Field for Analysis:</label>
                         <select id="diveInFieldSelect">
                             <option value="">-- Select Field --</option>
                         </select>
                     </div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4 mt-4">
                     <div class="kpi-card">
                         <div class="kpi-title">Latest Production (<span id="diveInLatestMonth"></span>)</div>
                         <div id="diveInLatestProdOE" class="kpi-value">-<span class="kpi-unit">OE</span></div>
                         <div id="diveInLatestProdOil" class="kpi-subvalue">-<span class="kpi-unit">Oil</span></div>
                         <div id="diveInLatestProdGas" class="kpi-subvalue">-<span class="kpi-unit">Gas</span></div>
                     </div>
                     <div class="kpi-card">
                         <div class="kpi-title">YoY Change (Latest Month OE)</div>
                         <div id="diveInYoYChange" class="kpi-value">-</div>
                     </div>
                     <div class="kpi-card">
                         <div class="kpi-title">Total in Selected Period (OE)</div>
                         <div id="diveInTotalProd" class="kpi-value">-<span class="kpi-unit">Mill Sm³</span></div>
                     </div>
                      <div class="kpi-card">
                         <div class="kpi-title">Total Last Calendar Year (OE)</div>
                         <div id="diveInTotalLastYear" class="kpi-value">-<span class="kpi-unit">Mill Sm³</span></div>
                     </div>
                 </div>
                 <div class="flex flex-wrap justify-between items-center mt-4 mb-2 gap-y-2">
                     <h3 id="diveInChartTitle" class="text-md font-semibold text-gray-600">Last 24 Months Production</h3>
                     <div class="flex gap-x-4 gap-y-1 items-center">
                         <div id="diveInChartToggle" class="flex gap-1">
                             <button data-mode="monthly" class="toggle-button active">Last 24 Months</button>
                             <button data-mode="yearly" class="toggle-button">Yearly</button>
                         </div>
                         <div class="flex items-center">
                             <input type="checkbox" id="showDailyToggle" class="mr-1 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                             <label for="showDailyToggle" class="text-xs text-gray-700">Show Daily Avg.</label>
                         </div>
                     </div>
                 </div>
                 <div class="small-chart-container" id="diveInChartContainer">
                      <button class="expand-button" data-chart-type="dive" title="Expand Chart">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"> <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" /> </svg>
                      </button>
                    <canvas id="yearlyFieldChart"></canvas>
                 </div>
            </div>


             <div class="mt-6 text-center">
                <button id="toggleTableButton" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300 text-sm">
                    Show Raw Data Table
                </button>
            </div>
        </div>

        <div id="tableWrapper" class="table-container mt-4 hidden">
            <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"></thead>
                <tbody class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

     <div id="chartModal" class="hidden" style="display: none;">
         <div id="modalOverlayElem" class="fixed inset-0 bg-black bg-opacity-75 z-[100]"></div>
         <div id="modalContent" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-lg p-6 md:p-8 shadow-xl z-[101] w-[95vw] h-[90vh] flex flex-col">
             <button id="closeModalButton" title="Close" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-3xl leading-none z-[102]">&times;</button>
             <div id="modalChartContainer" class="flex-grow relative">
                 <canvas id="modalChartCanvas"></canvas>
             </div>
         </div>
     </div>


    <script>
        // --- Global State & Config ---
        const csvUrl = 'https://factpages.sodir.no/public?/Factpages/external/tableview/field_production_monthly&rs:Command=Render&rc:Toolbar=false&rc:Parameters=f&IpAddress=not_used&CultureCode=nb-no&rs:Format=CSV&Top100=false';
        let productionChartInstance = null;
        let yearlyFieldChartInstance = null;
        let modalChartInstance = null;
        let mainChartConfig = {};
        let diveInChartConfig = {};
        let rawData = { headers: [], rows: [], fieldData: {} };
        let uniqueFields = [];
        let processedDataCache = null;
        let isFilterPanelOpen = false;
        let summarizeYearly = false;
        let fullDataStartDate = null;
        let fullDataEndDate = null;
        let kpiReferenceDateKey = null;
        let currentSortedDateKeys = [];
        let isTablePopulated = false;
        let diveInChartMode = 'monthly';
        let showDailyAverages = false;


        // --- DOM References ---
        // (Keep all DOM references from previous version)
        const filterPanel = document.getElementById('filterPanel');
        const filterOverlay = document.getElementById('filterOverlay');
        const burgerButton = document.getElementById('burgerButton');
        const closeFilterButton = document.getElementById('closeFilterButton');
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const dropZone = document.getElementById('dropZone');
        const csvDownloadLink = document.getElementById('csvDownloadLink');
        const browseButton = document.getElementById('browseButton');
        const fileInput = document.getElementById('fileInput');
        const fieldFilterSelect = document.getElementById('fieldFilter');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const resetFiltersButton = document.getElementById('resetFiltersButton');
        const dashboardContent = document.getElementById('dashboardContent');
        const kpiReferenceMonthSpan = document.getElementById('kpiReferenceMonthSpan');
        const prevKpiMonthButton = document.getElementById('prevKpiMonth');
        const nextKpiMonthButton = document.getElementById('nextKpiMonth');
        const kpiContainer = document.getElementById('kpiContainer');
        const datePresetButtonsContainer = document.getElementById('datePresetButtons');
        const summarizeYearlyCheckbox = document.getElementById('summarizeYearlyCheckbox');
        const mainChartContainer = document.getElementById('mainChartContainer');
        const chartCanvas = document.getElementById('productionChart');
        // Dive-In Area
        const fieldDiveInArea = document.getElementById('fieldDiveInArea');
        const diveInFieldSelect = document.getElementById('diveInFieldSelect');
        const diveInLatestMonth = document.getElementById('diveInLatestMonth');
        const diveInLatestProdOE = document.getElementById('diveInLatestProdOE');
        const diveInLatestProdOil = document.getElementById('diveInLatestProdOil');
        const diveInLatestProdGas = document.getElementById('diveInLatestProdGas');
        const diveInYoYChange = document.getElementById('diveInYoYChange');
        const diveInTotalProd = document.getElementById('diveInTotalProd');
        const diveInTotalLastYear = document.getElementById('diveInTotalLastYear');
        const diveInChartTitle = document.getElementById('diveInChartTitle');
        const diveInChartToggleContainer = document.getElementById('diveInChartToggle');
        const showDailyToggleCheckbox = document.getElementById('showDailyToggle');
        const diveInChartContainer = document.getElementById('diveInChartContainer');
        const yearlyFieldChartCanvas = document.getElementById('yearlyFieldChart');
        // Table
        const tableWrapper = document.getElementById('tableWrapper');
        const tableHead = document.querySelector('#dataTable thead');
        const tableBody = document.querySelector('#dataTable tbody');
        const toggleTableButton = document.getElementById('toggleTableButton');
        // Modal
        const chartModal = document.getElementById('chartModal');
        const modalOverlayElem = document.getElementById('modalOverlayElem'); // Use specific ID from HTML
        const modalChartCanvas = document.getElementById('modalChartCanvas');
        const closeModalButton = document.getElementById('closeModalButton');


        // --- Date Formatting Helpers (using date-fns) ---
        const { format: formatDate, parse: parseDate, addMonths, subMonths, subYears, startOfYear, endOfYear, isBefore, isAfter, isValid: isValidDate, eachMonthOfInterval, startOfMonth, getDaysInMonth, isLeapYear } = window.dateFns || {};
        const formatDateYYYYMM = (date) => formatDate && isValidDate(date) ? formatDate(date, 'yyyy-MM') : '';
        const parseDateYYYYMM = (str) => {
            if (!str) return null;
            const parseFn = parseDate || ((s, fmt, base) => new Date(parseInt(s.substring(0,4)), parseInt(s.substring(5,7)) - 1, 1));
            const date = parseFn(str, 'yyyy-MM', new Date());
            const validateFn = isValidDate || (d => !isNaN(d.getTime()));
            return validateFn(date) ? date : null;
        };
        const getDaysInMonthFallback = (date) => new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        const isLeapYearFallback = (date) => { const year = date.getFullYear(); return (year % 4 === 0 && year % 100 !== 0) || year % 400 === 0; };
        const _getDaysInMonth = getDaysInMonth || getDaysInMonthFallback;
        const _isLeapYear = isLeapYear || isLeapYearFallback;
        if (!formatDate) { console.error("date-fns not loaded, using basic date functions."); }


        // --- UI Functions ---
        function toggleFilterPanel(show) {
            // (Keep implementation from previous version)
            isFilterPanelOpen = show;
            if (show) {
                filterPanel.classList.remove('-translate-x-full');
                filterOverlay.classList.remove('hidden');
            } else {
                filterPanel.classList.add('-translate-x-full');
                filterOverlay.classList.add('hidden');
            }
        }

        // --- Data Processing ---
        function parseRawData(csvText) {
             // (Keep implementation from previous version)
             const lines = csvText.trim().split('\n');
             if (lines.length < 2) throw new Error('CSV needs header and data.');
             const headers = lines[0].split(',').map(h => h.trim());
             const rows = lines.slice(1).map(line => line.split(',').map(cell => cell.trim()));

             const fieldIdx = headers.indexOf('prfInformationCarrier');
             const yearIdx = headers.indexOf('prfYear');
             const monthIdx = headers.indexOf('prfMonth');
             const oilIdx = headers.indexOf('prfPrdOilNetMillSm3');
             const gasIdx = headers.indexOf('prfPrdGasNetBillSm3');
             const nglIdx = headers.indexOf('prfPrdNGLNetMillSm3');
             const condIdx = headers.indexOf('prfPrdCondensateNetMillSm3');
             const oeIdx = headers.indexOf('prfPrdOeNetMillSm3');

             if ([fieldIdx, yearIdx, monthIdx, oilIdx, gasIdx, oeIdx].includes(-1)) {
                 throw new Error('One or more required columns (Field, Year, Month, Oil, Gas, OE) not found.');
             }

             uniqueFields = [...new Set(rows.map(row => row[fieldIdx]))].sort();
             rawData.headers = headers;
             rawData.rows = rows;
             rawData.fieldData = {};

             let minDate = null; let maxDate = null;
             rows.forEach(row => {
                 const fieldName = row[fieldIdx];
                 const year = parseInt(row[yearIdx], 10);
                 const month = parseInt(row[monthIdx], 10);
                 if (isNaN(year) || isNaN(month)) return;

                 const dateKey = `${year}-${month.toString().padStart(2, '0')}`;
                 const date = parseDateYYYYMM(dateKey);
                 if (!isValidDate(date)) return;

                 if (minDate === null || isBefore(date, minDate)) minDate = date;
                 if (maxDate === null || isAfter(date, maxDate)) maxDate = date;

                 if (!rawData.fieldData[fieldName]) rawData.fieldData[fieldName] = {};
                 if (!rawData.fieldData[fieldName][dateKey]) {
                     rawData.fieldData[fieldName][dateKey] = {
                         year, month,
                         oil: parseFloat(row[oilIdx]) || 0,
                         gas: parseFloat(row[gasIdx]) || 0,
                         ngl: parseFloat(row[nglIdx]) || 0,
                         cond: parseFloat(row[condIdx]) || 0,
                         oe: parseFloat(row[oeIdx]) || 0
                     };
                 }
             });
             fullDataStartDate = minDate;
             fullDataEndDate = maxDate;
             setInitialDateRange();
             isTablePopulated = false;
        }

        function setInitialDateRange() {
            // (Keep implementation from previous version)
             if (fullDataStartDate && fullDataEndDate) {
                 startDateInput.value = formatDateYYYYMM(fullDataStartDate);
                 endDateInput.value = formatDateYYYYMM(fullDataEndDate);
             }
        }

        function filterAndProcessData() {
            // (Keep implementation from previous version)
            const selectedFields = Array.from(fieldFilterSelect.selectedOptions).map(opt => opt.value);
            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;

            if (!rawData || rawData.rows.length === 0) return null;

            const startDate = startDateStr ? parseDateYYYYMM(startDateStr) : null;
            const endDate = endDateStr ? parseDateYYYYMM(endDateStr) : null;

            const fieldDataFiltered = {};
            const monthlyTotals = {};
            const dateKeysInPeriod = new Set();

            Object.keys(rawData.fieldData).forEach(fieldName => {
                if (selectedFields.length > 0 && !selectedFields.includes(fieldName)) return;

                Object.keys(rawData.fieldData[fieldName]).forEach(dateKey => {
                    const entry = rawData.fieldData[fieldName][dateKey];
                    const entryDate = parseDateYYYYMM(dateKey);
                    if (!isValidDate(entryDate)) return;

                    const startDateMatch = !startDate || !isBefore(entryDate, startDate);
                    const endDateMatch = !endDate || !isAfter(entryDate, endDate);

                    if (startDateMatch && endDateMatch) {
                        dateKeysInPeriod.add(dateKey);

                        if (!monthlyTotals[dateKey]) {
                            monthlyTotals[dateKey] = { year: entry.year, month: entry.month, oil: 0, gas: 0, ngl: 0, cond: 0, oe: 0 };
                        }
                        monthlyTotals[dateKey].oil += entry.oil;
                        monthlyTotals[dateKey].gas += entry.gas;
                        monthlyTotals[dateKey].ngl += entry.ngl;
                        monthlyTotals[dateKey].cond += entry.cond;
                        monthlyTotals[dateKey].oe += entry.oe;

                        if (!fieldDataFiltered[fieldName]) fieldDataFiltered[fieldName] = {};
                        fieldDataFiltered[fieldName][dateKey] = entry;
                    }
                });
            });

            currentSortedDateKeys = Array.from(dateKeysInPeriod).sort();
            const mainChartTimeSeries = { labels: [], oil: [], gas: [], oe: [] };
            currentSortedDateKeys.forEach(key => {
                mainChartTimeSeries.labels.push(key);
                mainChartTimeSeries.oil.push(monthlyTotals[key]?.oil || 0);
                mainChartTimeSeries.gas.push(monthlyTotals[key]?.gas || 0);
                mainChartTimeSeries.oe.push(monthlyTotals[key]?.oe || 0);
            });

            processedDataCache = {
                filteredRowsForTable: [],
                mainChartTimeSeries,
                fieldData: fieldDataFiltered,
                sortedDateKeys: currentSortedDateKeys
            };
            return processedDataCache;
        }

        function calculateAnalyticalKPIs(filteredFieldData, referenceKey, allSortedKeys) {
            // (Keep implementation from previous version)
            const productionThreshold = 0.1;

            if (!referenceKey || !allSortedKeys || allSortedKeys.length === 0) {
                 return { topProducers: [], biggestMovers: [], latestDateKey: referenceKey, totalLatest: { oe: 0, oil: 0, gas: 0 }, sortedDateKeys: allSortedKeys };
            }

            let refIndex = allSortedKeys.indexOf(referenceKey);
            if (refIndex === -1) {
                 referenceKey = allSortedKeys[allSortedKeys.length - 1];
                 refIndex = allSortedKeys.length - 1;
            }
            const prevKey = refIndex > 0 ? allSortedKeys[refIndex - 1] : null;

            const fieldTotalsLatest = {};
            const fieldTotalsPrev = {};
            let totalLatest = { oe: 0, oil: 0, gas: 0 };

            Object.entries(filteredFieldData).forEach(([fieldName, dateData]) => {
                if (dateData[referenceKey]) {
                    const latest = dateData[referenceKey];
                    const primary = latest.oil > (latest.gas * 1000) ? 'oil' : 'gas';
                    fieldTotalsLatest[fieldName] = { oe: latest.oe, oil: latest.oil, gas: latest.gas, primary };
                    totalLatest.oe += latest.oe;
                    totalLatest.oil += latest.oil;
                    totalLatest.gas += latest.gas;
                }
                if (prevKey && dateData[prevKey]) {
                     const prev = dateData[prevKey];
                     fieldTotalsPrev[fieldName] = { oe: prev.oe, oil: prev.oil, gas: prev.gas };
                }
            });

            const topProducers = Object.entries(fieldTotalsLatest)
                .sort(([, dataA], [, dataB]) => dataB.oe - dataA.oe)
                .slice(0, 10)
                .map(([name, data]) => ({ name, oe: data.oe, primary: data.primary }));

            const movers = [];
            Object.keys(fieldTotalsLatest).forEach(fieldName => {
                const latest = fieldTotalsLatest[fieldName];
                const prev = fieldTotalsPrev[fieldName];
                if (latest.oe > productionThreshold || (prev !== undefined && prev.oe > productionThreshold)) {
                    let change = 0; let percentChange = 0;
                    if (prev !== undefined) {
                        change = latest.oe - prev.oe;
                        if (prev.oe !== 0) percentChange = (change / prev.oe) * 100;
                        else if (latest.oe > 0) percentChange = Infinity;
                        movers.push({ name: fieldName, change, percentChange, latestOE: latest.oe, prevOE: prev.oe, primary: latest.primary });
                    } else {
                        movers.push({ name: fieldName, change: latest.oe, percentChange: Infinity, latestOE: latest.oe, prevOE: 0, primary: latest.primary });
                    }
                }
            });

             const sortedMovers = movers.sort((a, b) => {
                 const absA = Math.abs(a.percentChange);
                 const absB = Math.abs(b.percentChange);
                 if (absA === Infinity && absB === Infinity) return Math.abs(b.change) - Math.abs(a.change);
                 if (absA === Infinity) return -1;
                 if (absB === Infinity) return 1;
                 return absB - absA;
             }).slice(0, 5);

             return { topProducers, biggestMovers: sortedMovers, latestDateKey: referenceKey, totalLatest, sortedDateKeys: allSortedKeys };
        }


        // --- Rendering Functions ---
        function renderFieldFilter() {
            // (Keep implementation from previous version)
             fieldFilterSelect.innerHTML = '';
             uniqueFields.forEach(field => {
                 const option = document.createElement('option');
                 option.value = field; option.textContent = field;
                 fieldFilterSelect.appendChild(option);
             });
        }

        function renderDiveInFieldSelect() {
            // (Keep implementation from previous version)
             diveInFieldSelect.innerHTML = '<option value="">-- Select Field --</option>';
             uniqueFields.forEach(field => {
                 const option = document.createElement('option');
                 option.value = field;
                 option.textContent = field;
                 diveInFieldSelect.appendChild(option);
             });
        }


        function renderKPIs(kpiResults) {
            // (Keep implementation from previous version)
            kpiContainer.innerHTML = '';

            if (!kpiResults || !kpiResults.latestDateKey) {
                kpiContainer.innerHTML = '<div class="kpi-card col-span-full"><div class="kpi-title">No data available for reference month.</div></div>';
                prevKpiMonthButton.disabled = true;
                nextKpiMonthButton.disabled = true;
                kpiReferenceMonthSpan.textContent = 'N/A';
                return;
            }
            const refMonth = kpiResults.latestDateKey;
            kpiReferenceMonthSpan.textContent = refMonth;

            // KPI 1: Total Production
            const kpiTotal = document.createElement('div');
            kpiTotal.className = 'kpi-card';
            kpiTotal.innerHTML = `
                <div class="kpi-title">Total Production (${refMonth})</div>
                <div class="kpi-value">${kpiResults.totalLatest.oe.toFixed(3)}<span class="kpi-unit">Mill Sm³ OE</span></div>
                <div class="kpi-subvalue">Oil: ${kpiResults.totalLatest.oil.toFixed(3)} Mill Sm³</div>
                <div class="kpi-subvalue">Gas: ${kpiResults.totalLatest.gas.toFixed(3)} Bill Sm³</div>
            `;
            kpiContainer.appendChild(kpiTotal);

            // KPI 2: Top 10 Producers
            const kpiTop = document.createElement('div');
            kpiTop.className = 'kpi-card';
            let topProducersHtml = kpiResults.topProducers.map(p => {
                 const colorClass = p.primary === 'oil' ? 'field-oil' : 'field-gas';
                 // Make the span clickable
                 return `<div class="text-xs truncate" title="${p.name}: ${p.oe.toFixed(3)} Mill Sm³ OE"><span class="${colorClass} clickable-field-name" data-field-name="${p.name}">${p.name}</span>: ${p.oe.toFixed(3)}</div>`;
             }).join('');
            if (!topProducersHtml) topProducersHtml = '<div class="text-xs text-gray-400">N/A</div>';
            kpiTop.innerHTML = `
                <div class="kpi-title">Top 10 Producers (${refMonth} OE)</div>
                <div class="space-y-1">${topProducersHtml}</div>`;
            kpiContainer.appendChild(kpiTop);

            // KPI 3: Biggest Monthly Change
            const kpiMovers = document.createElement('div');
            kpiMovers.className = 'kpi-card';
            let moversHtml = kpiResults.biggestMovers.map(m => {
                 const changeText = m.percentChange === Infinity ? `Started` : `${m.percentChange >= 0 ? '+' : ''}${m.percentChange.toFixed(1)}%`;
                 const colorClassChange = m.change > 0 ? 'text-green-600' : (m.change < 0 ? 'text-red-600' : '');
                 const fieldColorClass = m.primary === 'oil' ? 'field-oil' : 'field-gas';
                 // Make the span clickable
                 return `
                     <div class="text-xs mb-1 flex justify-between items-center" title="${m.name}">
                        <span class="${fieldColorClass} mr-1 truncate flex-shrink clickable-field-name" data-field-name="${m.name}" style="max-width: 50%;">${m.name}</span>
                        <span class="text-gray-500 text-[11px] whitespace-nowrap flex-shrink-0 mx-1">(${m.prevOE.toFixed(3)}&#x2192;${m.latestOE.toFixed(3)})</span>
                        <span class="${colorClassChange} ml-1 font-medium flex-shrink-0">${changeText}</span>
                     </div>`;
             }).join('');
            if (!moversHtml) moversHtml = '<div class="text-xs text-gray-400">N/A (Threshold: 0.1 OE)</div>';
            kpiMovers.innerHTML = `
                <div class="kpi-title">Biggest Monthly Change (OE)</div>
                <div class="space-y-1">${moversHtml}</div>`;
            kpiContainer.appendChild(kpiMovers);

            // Update KPI navigation button states
            const refIndex = kpiResults.sortedDateKeys.indexOf(refMonth);
            prevKpiMonthButton.disabled = refIndex <= 0;
            nextKpiMonthButton.disabled = refIndex >= kpiResults.sortedDateKeys.length - 1;
        }

        function renderProductionChart(timeSeries) {
            // (Keep implementation from previous version)
              const ctx = chartCanvas.getContext('2d');
             if (productionChartInstance) productionChartInstance.destroy();

             let displayData = timeSeries;

             if (summarizeYearly && timeSeries && timeSeries.labels.length > 0) {
                 const yearlySummary = {};
                 timeSeries.labels.forEach((label, index) => {
                     const year = label.substring(0, 4);
                     if (!yearlySummary[year]) yearlySummary[year] = { oil: 0, gas: 0, oe: 0 };
                     yearlySummary[year].oil += timeSeries.oil[index];
                     yearlySummary[year].gas += timeSeries.gas[index];
                     yearlySummary[year].oe += timeSeries.oe[index];
                 });
                 const yearlyLabels = Object.keys(yearlySummary).sort();
                 displayData = {
                     labels: yearlyLabels,
                     oil: yearlyLabels.map(year => yearlySummary[year].oil),
                     gas: yearlyLabels.map(year => yearlySummary[year].gas),
                     oe: yearlyLabels.map(year => yearlySummary[year].oe),
                 };
             }

             if (!displayData || displayData.labels.length === 0) {
                 ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
                 ctx.textAlign = 'center'; ctx.fillStyle = '#6b7280';
                 ctx.fillText('No data to display for selected filters.', chartCanvas.width / 2, chartCanvas.height / 2);
                 mainChartConfig = null;
                 return;
             }

             mainChartConfig = {
                 type: 'line',
                 data: {
                     labels: displayData.labels,
                     datasets: [
                         { label: 'Total Oil (Mill Sm³)', data: displayData.oil, borderColor: 'rgb(54, 162, 235)', tension: 0.1, yAxisID: 'yProd' },
                         { label: 'Total Gas (Bill Sm³)', data: displayData.gas, borderColor: 'rgb(255, 99, 132)', tension: 0.1, yAxisID: 'yProd' },
                         { label: 'Total OE (Mill Sm³)', data: displayData.oe, borderColor: 'rgb(75, 192, 192)', tension: 0.1, yAxisID: 'yProd' }
                     ]
                 },
                  options: {
                     responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                     scales: { x: { title: { display: true, text: summarizeYearly ? 'Year' : 'Month' } }, yProd: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Production Volume' } } },
                     plugins: { tooltip: { callbacks: { label: ctx => `${ctx.dataset.label || ''}: ${ctx.parsed.y !== null ? ctx.parsed.y.toFixed(3) : 'N/A'}` } } }
                 }
             };

            productionChartInstance = new Chart(ctx, mainChartConfig);
        }

        function populateTable() {
            // (Keep implementation from previous version)
             console.log("Populating table for the first time...");
             tableHead.innerHTML = ''; tableBody.innerHTML = '';

             if (!rawData || rawData.rows.length === 0) {
                  tableBody.innerHTML = '<tr><td colspan="100%" class="px-6 py-4 text-center text-gray-500">No raw data available.</td></tr>';
                  return;
             }

             const headerRow = document.createElement('tr');
             rawData.headers.forEach(headerText => {
                 const th = document.createElement('th');
                 th.scope = 'col'; th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap';
                 th.textContent = headerText; headerRow.appendChild(th);
             });
             tableHead.appendChild(headerRow);

             rawData.rows.forEach(rowArray => {
                 const row = document.createElement('tr');
                 rowArray.forEach(cellText => {
                     const td = document.createElement('td');
                     td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                     td.textContent = cellText; row.appendChild(td);
                 });
                 tableBody.appendChild(row);
             });
             isTablePopulated = true;
             console.log("Table populated.");
        }

        // Updated renderFieldDiveIn for unit conversion, 24 month view, and daily toggle
        function renderFieldDiveIn(fieldName) {
             // (Keep KPI calculation and update logic from previous version)
            if (!fieldName) {
                fieldDiveInArea.classList.add('hidden');
                diveInChartConfig = null;
                return;
            }
            const fieldHistory = rawData.fieldData?.[fieldName];
            if (!fieldHistory) {
                fieldDiveInArea.classList.add('hidden');
                diveInChartConfig = null;
                return;
            }
            const startDateStr = startDateInput.value;
            const endDateStr = endDateInput.value;
            const startDate = startDateStr ? parseDateYYYYMM(startDateStr) : null;
            const endDate = endDateStr ? parseDateYYYYMM(endDateStr) : null;
            const dataForPeriod = {};
            const sortedKeysFullHistory = Object.keys(fieldHistory).sort();
            const sortedKeysInPeriod = [];
            sortedKeysFullHistory.forEach(dateKey => {
                 const entryDate = parseDateYYYYMM(dateKey);
                 if (!isValidDate(entryDate)) return;
                 const startDateMatch = !startDate || !isBefore(entryDate, startDate);
                 const endDateMatch = !endDate || !isAfter(entryDate, endDate);
                 if (startDateMatch && endDateMatch) {
                     dataForPeriod[dateKey] = fieldHistory[dateKey];
                     sortedKeysInPeriod.push(dateKey);
                 }
            });

            diveInChartToggleContainer.querySelectorAll('button').forEach(btn => {
                 btn.classList.toggle('active', btn.dataset.mode === diveInChartMode);
            });
            showDailyToggleCheckbox.checked = showDailyAverages;

            if (sortedKeysInPeriod.length === 0) {
                 fieldDiveInArea.innerHTML = ` ... No data message ... `; // Simplified
                 attachDiveInListeners();
                 fieldDiveInArea.classList.remove('hidden');
                 diveInChartConfig = null;
                 return;
            }

            const latestDateKey = sortedKeysInPeriod[sortedKeysInPeriod.length - 1];
            const latestData = dataForPeriod[latestDateKey];
            const latestDate = parseDateYYYYMM(latestDateKey);
            const prevYearDate = subYears(latestDate, 1);
            const prevYearKey = formatDateYYYYMM(prevYearDate);
            const prevYearDataRaw = rawData.fieldData?.[fieldName]?.[prevYearKey];
            let yoyChangeText = "N/A";
            if (prevYearDataRaw?.oe > 0) { yoyChangeText = `${((latestData.oe - prevYearDataRaw.oe) / prevYearDataRaw.oe * 100).toFixed(1)}%`; if(latestData.oe >= prevYearDataRaw.oe) yoyChangeText = "+" + yoyChangeText; }
            else if (!prevYearDataRaw && isValidDate(prevYearDate)) { yoyChangeText = "No Prior Year Data"; }
            const totalOeInPeriod = sortedKeysInPeriod.reduce((sum, key) => sum + dataForPeriod[key].oe, 0);
            let totalOeLastYear = 0;
            if(isValidDate(latestDate)) { const lastCalYear = latestDate.getFullYear() - 1; Object.keys(rawData.fieldData?.[fieldName] || {}).forEach(key => { if (rawData.fieldData[fieldName][key].year === lastCalYear) totalOeLastYear += rawData.fieldData[fieldName][key].oe; }); }

             if (!document.getElementById('diveInLatestProdOE')) {
                  fieldDiveInArea.innerHTML = ` ... Rebuild structure ... `;
                  attachDiveInListeners();
             }
             document.getElementById('diveInFieldSelect').value = fieldName;
             document.getElementById('diveInLatestMonth').textContent = latestDateKey;
             document.getElementById('diveInLatestProdOE').innerHTML = `${latestData.oe.toFixed(3)}<span class="kpi-unit">OE</span>`;
             document.getElementById('diveInLatestProdOil').innerHTML = `${latestData.oil.toFixed(3)}<span class="kpi-unit">Oil Mill Sm³</span>`;
             document.getElementById('diveInLatestProdGas').innerHTML = `${latestData.gas.toFixed(3)}<span class="kpi-unit">Gas Bill Sm³</span>`;
             document.getElementById('diveInYoYChange').textContent = yoyChangeText;
             document.getElementById('diveInYoYChange').className = `kpi-value ${yoyChangeText.startsWith('+') ? 'text-green-600' : (yoyChangeText.startsWith('-') ? 'text-red-600' : '')}`;
             document.getElementById('diveInTotalProd').innerHTML = `${totalOeInPeriod.toFixed(3)}<span class="kpi-unit">Mill Sm³</span>`;
             document.getElementById('diveInTotalLastYear').innerHTML = `${totalOeLastYear.toFixed(3)}<span class="kpi-unit">Mill Sm³</span>`;

            // --- Prepare Chart Data ---
            let chartLabels = [];
            let chartOilData = []; // Target: kSm³
            let chartGasData = []; // Target: Mill Sm³
            let chartTitle = "";
            let xAxisTitle = "";
            const dailySuffix = showDailyAverages ? "/day" : "/mo";
            let yAxisTitle = `Volume (Gas: Mill Sm³${dailySuffix}, Oil: kSm³${dailySuffix})`;

            if (diveInChartMode === 'monthly') {
                // Use 24 months lookback
                chartTitle = `Last 24 Months Production`;
                xAxisTitle = "Month";
                const monthlyDataProcessed = {};
                const endDateFor24m = parseDateYYYYMM(latestDateKey);
                const startDateFor24m = startOfMonth(subMonths(endDateFor24m, 23)); // Look back 23 months

                if (eachMonthOfInterval && isValidDate(startDateFor24m) && isValidDate(endDateFor24m)) {
                    const intervalMonths = eachMonthOfInterval({ start: startDateFor24m, end: endDateFor24m });
                    intervalMonths.forEach(monthDate => {
                        const monthKey = formatDateYYYYMM(monthDate);
                        const entry = dataForPeriod[monthKey]; // Use data filtered by main date range
                        const originalOil = entry?.oil || 0;
                        const originalGas = entry?.gas || 0;
                        const daysInMonth = _getDaysInMonth(monthDate);
                        const divisor = showDailyAverages ? daysInMonth : 1;

                        if (divisor > 0) {
                             monthlyDataProcessed[monthKey] = {
                                 // Oil: Mill Sm³/mo -> kSm³/mo|day
                                 oil: (originalOil * 1000) / divisor,
                                 // Gas: Bill Sm³/mo -> Mill Sm³/mo|day
                                 gas: (originalGas * 1000) / divisor
                             };
                        } else { monthlyDataProcessed[monthKey] = { oil: 0, gas: 0 }; }
                    });
                }

                chartLabels = Object.keys(monthlyDataProcessed).sort();
                chartOilData = chartLabels.map(key => monthlyDataProcessed[key].oil);
                chartGasData = chartLabels.map(key => monthlyDataProcessed[key].gas);

            } else { // Yearly mode
                chartTitle = "Yearly Production Breakdown";
                xAxisTitle = "Year";
                if (showDailyAverages) { yAxisTitle = `Avg Daily Volume (Gas: Mill Sm³/day, Oil: kSm³/day)`; }
                else { yAxisTitle = `Total Volume (Gas: Mill Sm³/yr, Oil: kSm³/yr)`; } // Corrected yearly total units

                const yearlyTotals = {};
                sortedKeysInPeriod.forEach(key => {
                    const year = dataForPeriod[key].year;
                    if (!yearlyTotals[year]) yearlyTotals[year] = { oil: 0, gas: 0, yearDate: parseDateYYYYMM(`${year}-01`) };
                    yearlyTotals[year].oil += dataForPeriod[key].oil; // Mill Sm³/yr
                    yearlyTotals[year].gas += dataForPeriod[key].gas; // Bill Sm³/yr
                });

                chartLabels = Object.keys(yearlyTotals).sort();
                chartOilData = chartLabels.map(year => {
                    const originalOil = yearlyTotals[year].oil;
                    const daysInYear = _isLeapYear(yearlyTotals[year].yearDate) ? 366 : 365;
                    const divisor = showDailyAverages ? daysInYear : 1;
                    // Oil: Mill Sm³/yr -> kSm³/yr|day
                    return (originalOil * 1000) / divisor;
                });
                chartGasData = chartLabels.map(year => {
                    const originalGas = yearlyTotals[year].gas;
                    const daysInYear = _isLeapYear(yearlyTotals[year].yearDate) ? 366 : 365;
                    const divisor = showDailyAverages ? daysInYear : 1;
                     // Gas: Bill Sm³/yr -> Mill Sm³/yr|day
                    return (originalGas * 1000) / divisor;
                });
            }

            document.getElementById('diveInChartTitle').textContent = chartTitle;

            // --- Render Chart & Store Config ---
            const ctx = yearlyFieldChartCanvas.getContext('2d');
            if (yearlyFieldChartInstance) yearlyFieldChartInstance.destroy();

            diveInChartConfig = { // Store config for modal
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        { label: `Gas (Mill Sm³${dailySuffix})`, data: chartGasData, backgroundColor: 'rgba(255, 99, 132, 0.7)' },
                        { label: `Oil (kSm³${dailySuffix})`, data: chartOilData, backgroundColor: 'rgba(54, 162, 235, 0.7)' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { tooltip: { mode: 'index' } },
                    scales: {
                        x: { stacked: true, title: { display: true, text: xAxisTitle } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: yAxisTitle } }
                    }
                }
            };

            yearlyFieldChartInstance = new Chart(ctx, diveInChartConfig);
            fieldDiveInArea.classList.remove('hidden');
        }


        // --- Update Orchestration ---
        function updateDashboard(options = { preserveKpiMonth: false }) {
            // (Keep implementation from previous version)
            console.log("Updating dashboard...");
            errorDiv.classList.add('hidden');

            try {
                const processedData = filterAndProcessData();
                if (!processedData) throw new Error("No data processed or available for filters.");

                if (!options.preserveKpiMonth || !kpiReferenceDateKey || !processedData.sortedDateKeys.includes(kpiReferenceDateKey)) {
                    kpiReferenceDateKey = processedData.sortedDateKeys[processedData.sortedDateKeys.length - 1] || null;
                }

                const kpiResults = calculateAnalyticalKPIs(
                    processedData.fieldData,
                    kpiReferenceDateKey,
                    processedData.sortedDateKeys
                );

                renderKPIs(kpiResults);
                renderProductionChart(processedData.mainChartTimeSeries);

                let currentDiveInField = diveInFieldSelect.value;
                if (!currentDiveInField && uniqueFields.length > 0) {
                     const topMover = kpiResults.biggestMovers[0]?.name;
                     currentDiveInField = topMover || uniqueFields[0] || "";
                     diveInFieldSelect.value = currentDiveInField;
                }

                if (currentDiveInField) {
                     renderFieldDiveIn(currentDiveInField);
                } else {
                     fieldDiveInArea.classList.add('hidden');
                }

            } catch (error) {
                console.error("Error updating dashboard:", error);
                errorDiv.textContent = `Error updating dashboard: ${error.message}`;
                errorDiv.classList.remove('hidden');
                statusDiv.classList.add('hidden');
                kpiContainer.innerHTML = '<div class="kpi-card col-span-full"><div class="kpi-title text-red-500">Error updating data.</div></div>';
                renderProductionChart(null); /* populateTable(null); */ fieldDiveInArea.classList.add('hidden');
            }
        }


        // --- Event Listeners --- (Attached in DOMContentLoaded)

        // --- Drag & Drop Handlers --- (Attached in DOMContentLoaded)

        // --- Initial Load ---
        function displayDashboardOnInit(csvText, source) {
             // (Keep implementation from previous version)
             try {
                statusDiv.textContent = `Parsing data from ${source}...`;
                statusDiv.classList.remove('hidden');
                parseRawData(csvText);
                renderFieldFilter();
                renderDiveInFieldSelect();
                dashboardContent.classList.remove('hidden');
                dropZone.classList.add('hidden');
                updateDashboard({ preserveKpiMonth: false });
                statusDiv.textContent = `Successfully loaded data from ${source}.`;
                statusDiv.className = 'mb-4 p-3 bg-green-100 text-green-800 rounded text-sm';
                errorDiv.classList.add('hidden');
                setTimeout(() => { statusDiv.classList.add('hidden'); }, 2500);
            } catch (error) {
                console.error(`Initial processing error from ${source}:`, error);
                statusDiv.classList.add('hidden');
                errorDiv.textContent = `Error processing initial data: ${error.message}`;
                errorDiv.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
                dropZone.classList.remove('hidden');
                csvDownloadLink.href = csvUrl;
            }
        }

        // Removed initialUrlLoad function

        // Helper to re-attach dive-in listeners
        function attachDiveInListeners() {
             const select = document.getElementById('diveInFieldSelect');
             const toggle = document.getElementById('diveInChartToggle');
             const dailyCheck = document.getElementById('showDailyToggle');

             const selectHandler = (event) => renderFieldDiveIn(event.target.value);
             const toggleHandler = (event) => {
                 if (event.target.tagName === 'BUTTON') {
                     const newMode = event.target.dataset.mode;
                     if (newMode && newMode !== diveInChartMode) {
                         diveInChartMode = newMode;
                         renderFieldDiveIn(document.getElementById('diveInFieldSelect').value);
                     }
                 }
             };
             const dailyCheckHandler = (event) => {
                 showDailyAverages = event.target.checked;
                 renderFieldDiveIn(document.getElementById('diveInFieldSelect').value);
             };

             // Use more robust listener attachment/detachment
             if (select) {
                 select.removeEventListener('change', selectHandler); // Remove potential old listener
                 select.addEventListener('change', selectHandler);
             }
             if (toggle) {
                 toggle.removeEventListener('click', toggleHandler);
                 toggle.addEventListener('click', toggleHandler);
             }
             if (dailyCheck) {
                  dailyCheck.removeEventListener('change', dailyCheckHandler);
                  dailyCheck.addEventListener('change', dailyCheckHandler);
             }
        }


        // --- Run Initial Load & Attach Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
             // Set download link href immediately
             csvDownloadLink.href = csvUrl;

             // Ensure modal is hidden initially
             chartModal.classList.add('hidden');
             chartModal.style.display = 'none';

             // Filter Panel Toggle Listeners
             burgerButton.addEventListener('click', (e) => { e.stopPropagation(); toggleFilterPanel(true); });
             closeFilterButton.addEventListener('click', () => toggleFilterPanel(false));
             filterOverlay.addEventListener('click', () => toggleFilterPanel(false));
             filterPanel.addEventListener('click', (e) => e.stopPropagation());

             // Filter Control Listeners (Main Filters)
             fieldFilterSelect.addEventListener('change', () => updateDashboard({ preserveKpiMonth: false }));
             startDateInput.addEventListener('change', () => updateDashboard({ preserveKpiMonth: false }));
             endDateInput.addEventListener('change', () => updateDashboard({ preserveKpiMonth: false }));
             resetFiltersButton.addEventListener('click', () => {
                 fieldFilterSelect.selectedIndex = -1;
                 setInitialDateRange();
                 summarizeYearlyCheckbox.checked = false;
                 summarizeYearly = false;
                 kpiReferenceDateKey = null;
                 datePresetButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                 datePresetButtonsContainer.querySelector('button[data-range="all"]')?.classList.add('active');
                 diveInFieldSelect.value = "";
                 diveInChartMode = 'monthly';
                 showDailyAverages = false;
                 showDailyToggleCheckbox.checked = false;
                 updateDashboard({ preserveKpiMonth: false });
             });

            // Attach Dive-In Listeners initially
            attachDiveInListeners();


             // Chart Control Listeners
             datePresetButtonsContainer.addEventListener('click', (event) => {
                 if (event.target.tagName === 'BUTTON' && fullDataEndDate) {
                     const range = event.target.getAttribute('data-range');
                     datePresetButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                     event.target.classList.add('active');
                     let newStartDate = fullDataStartDate;
                     const currentEndDate = parseDateYYYYMM(endDateInput.value) || fullDataEndDate;
                     if (range === '1y') newStartDate = subYears(currentEndDate, 1);
                     else if (range === '5y') newStartDate = subYears(currentEndDate, 5);
                     else if (range === '10y') newStartDate = subYears(currentEndDate, 10);
                     if (!isValidDate(newStartDate) || isBefore(newStartDate, fullDataStartDate)) {
                         newStartDate = fullDataStartDate;
                     }
                     startDateInput.value = formatDateYYYYMM(newStartDate);
                     endDateInput.value = formatDateYYYYMM(currentEndDate);
                     updateDashboard({ preserveKpiMonth: false });
                 }
             });
             summarizeYearlyCheckbox.addEventListener('change', (event) => {
                 summarizeYearly = event.target.checked;
                 updateDashboard({ preserveKpiMonth: true });
             });

             // KPI Navigation Listeners
             prevKpiMonthButton.addEventListener('click', () => {
                 const currentIndex = currentSortedDateKeys.indexOf(kpiReferenceDateKey);
                 if (currentIndex > 0) {
                     kpiReferenceDateKey = currentSortedDateKeys[currentIndex - 1];
                     updateDashboard({ preserveKpiMonth: true });
                 }
             });
             nextKpiMonthButton.addEventListener('click', () => {
                 const currentIndex = currentSortedDateKeys.indexOf(kpiReferenceDateKey);
                 if (currentIndex >= 0 && currentIndex < currentSortedDateKeys.length - 1) {
                     kpiReferenceDateKey = currentSortedDateKeys[currentIndex + 1];
                     updateDashboard({ preserveKpiMonth: true });
                 }
             });

            // KPI Click Listener (Event Delegation)
            kpiContainer.addEventListener('click', (event) => {
                const target = event.target.closest('.clickable-field-name'); // Find the clickable span
                if (target) {
                    const fieldName = target.dataset.fieldName;
                    if (fieldName && uniqueFields.includes(fieldName)) {
                        console.log(`KPI field clicked: ${fieldName}`);
                        diveInFieldSelect.value = fieldName; // Update dropdown
                        renderFieldDiveIn(fieldName); // Update dive-in section
                    }
                }
            });


             // Table Toggle Listener (Deferred Population)
             toggleTableButton.addEventListener('click', () => {
                 if (!isTablePopulated) {
                     populateTable();
                 }
                 const isHidden = tableWrapper.classList.toggle('hidden');
                 toggleTableButton.textContent = isHidden ? 'Show Raw Data Table' : 'Hide Raw Data Table';
             });

             // File Input Handling (Browse Button and Drop Zone)
             function handleFile(file) {
                 if (file && (file.type === 'text/csv' || file.name.toLowerCase().endsWith('.csv'))) {
                     statusDiv.textContent = `Reading file: ${file.name}...`;
                     statusDiv.classList.remove('hidden');
                     errorDiv.classList.add('hidden');
                     const reader = new FileReader();
                     reader.onload = (e_onload) => {
                         displayDashboardOnInit(e_onload.target.result, 'File Upload');
                         fileInput.value = null;
                     };
                     reader.onerror = (e_onerror) => { /* ... error handling ... */ };
                     reader.readAsText(file);
                 } else if (file) { /* ... handle wrong file type ... */ }
             }

             browseButton.addEventListener('click', () => { fileInput.click(); });
             fileInput.addEventListener('change', (event) => { handleFile(event.target.files[0]); });
             dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
             dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
             dropZone.addEventListener('drop', (e) => {
                 e.preventDefault(); dropZone.classList.remove('dragover');
                 if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
             });

             // Modal Chart Logic
             const modalOverlayElem = document.getElementById('modalOverlayElem'); // Use specific ID from HTML

             function openChartModal(chartConfig) {
                 if (!chartConfig) {
                     console.error("Cannot open modal: chart config is missing.");
                     return;
                 }
                 console.log("Opening modal with config:", chartConfig);

                 chartModal.style.display = 'flex';
                 chartModal.classList.remove('hidden');

                 setTimeout(() => {
                     const ctx = modalChartCanvas.getContext('2d');
                     if (!ctx) {
                         console.error("Cannot get modal canvas context.");
                         chartModal.classList.add('hidden');
                         chartModal.style.display = 'none';
                         return;
                     }

                     if (modalChartInstance) {
                         modalChartInstance.destroy();
                     }

                     const modalOptions = JSON.parse(JSON.stringify(chartConfig.options));
                     modalOptions.maintainAspectRatio = false;

                     try {
                         modalChartInstance = new Chart(ctx, {
                             type: chartConfig.type,
                             data: JSON.parse(JSON.stringify(chartConfig.data)),
                             options: modalOptions
                         });
                         console.log("Modal chart created:", modalChartInstance);
                     } catch (error) {
                         console.error("Error creating modal chart:", error);
                         closeChartModal();
                     }
                 }, 50);
             }

             function closeChartModal() {
                 console.log("Closing modal...");
                 if (modalChartInstance) {
                     modalChartInstance.destroy();
                     modalChartInstance = null;
                     console.log("Modal chart instance destroyed.");
                 }
                 chartModal.classList.add('hidden');
                 chartModal.style.display = 'none';
                 console.log("Modal hidden.");
             }

             // Add listeners for expand buttons
             document.querySelectorAll('.expand-button').forEach(button => {
                 button.addEventListener('click', (e) => {
                     const chartType = e.currentTarget.dataset.chartType;
                     console.log(`Expand button clicked for: ${chartType}`);
                     if (chartType === 'main' && mainChartConfig) {
                         openChartModal(mainChartConfig);
                     } else if (chartType === 'dive' && diveInChartConfig) {
                         openChartModal(diveInChartConfig);
                     } else {
                         console.warn("No chart config found for:", chartType);
                     }
                 });
             });

             // Add listeners for closing modal
             closeModalButton.addEventListener('click', closeChartModal);
             modalOverlayElem.addEventListener('click', closeChartModal);


             // No initial URL load, page starts with drop zone visible.
             // statusDiv.textContent = "Please load data using the options below.";
             // statusDiv.classList.remove('hidden'); // Keep status hidden initially

        });

    </script>

</body>
</html>
